name: scaffold

on:
  workflow_dispatch:
  pull_request:
    paths:
      - .github/workflows/scaffold.yaml
  push:
    branches:
      - main
    paths:
      - .github/workflows/scaffold.yaml

env:
  KUBEBUILDER_VERSION: v3.9.0

jobs:
  create:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version: 1.20.0
          cache: true

      - run: |
          curl -L -o kubebuilder https://github.com/kubernetes-sigs/kubebuilder/releases/download/${KUBEBUILDER_VERSION}/kubebuilder_$(go env GOOS)_$(go env GOARCH)
          chmod +x kubebuilder && mv kubebuilder /usr/local/bin/

      - run: rm -vfr PROJECT api config controllers bin hack e2e_test Makefile Dockerfile .*ignore go.* *.go

      - run: go version
      - run: kubebuilder version
      - run: kubebuilder init --domain int128.github.io --repo int128.github.io/kubebuilder-updates
      - run: kubebuilder create api --group webapp --version v1 --kind Guestbook --controller --resource
      - run: make test

      - run: git checkout -- e2e_test
      - uses: int128/update-generated-files-action@v2
